{% extends 'base.html.twig' %}
{% block title %}Sample Aliquot Lookup - {% endblock %}
{% block body %}
    {% set order = sample.nphOrder %}
    {% set sampleCode =  sample.sampleCode %}
    <div class="page-header">
        <h2><i class="fa fa-medkit" aria-hidden="true"></i> Aliquot Samples</h2>
    </div>
    <div class="row">
        <div class="col-sm-5">
            {{ form_start(sampleIdForm, { attr: { class: 'disable-enter prevent-resubmit', action:
                path('nph_samples_aliquot') } }) }}
            {{ form_widget(sampleIdForm) }}
            <p>
                <button type="submit" class="btn btn-primary">Go</button>
            </p>
            {{ form_end(sampleIdForm) }}
            <div class="well bg-white">
                <div class="text-center">
                    <p><strong>Aliquot Instructions for {{ samples[sampleCode]}}</strong></p>
                    <p><u>Expected Tubes and Volumes for {{ samples[sampleCode] }}</u></p>
                    {% for aliquot in aliquots %}
                        <p>
                            {{ aliquot.container }}: {{ aliquot.expectedAliquots }} Volume: {{ aliquot
                            .expectedVolume }} {{ aliquot.units }}
                        </p>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="col-sm-7">
            <div class="panel panel-default">
                <div class="panel-heading clearfix">
                    <div class="pull-right">
                        <strong class="text-primary">
                            Module {{ order.module }} | Visit {{ order.visitType }} | {{ timePoints[order.timepoint] }}
                            | {{ samples[sampleCode]}}
                        </strong>
                        <dl class="dl-horizontal">
                            <dt>Order ID</dt>
                            <dd>{{ sample.nphOrder.orderId }}</dd>
                            <dt>Sample ID</dt>
                            <dd>{{ sample.sampleId }}</dd>
                        </dl>
                    </div>
                    <div class="pull-left">
                        <dl class="dl-horizontal">
                            <dt>Name</dt>
                            <dd>{{ participant.lastName }}
                                , {{ participant.firstName }} {{ participant.middleName }}</dd>
                            <dt>Participant ID</dt>
                            <dd>{{ participant.id }}</dd>
                            <dt>Biobank ID</dt>
                            <dd>{{ participant.biobankId }}</dd>
                            <dt>Site</dt>
                            <dd>{{ participant.site }}</dd>
                            <dt>DOB</dt>
                            <dd>{{ participant.dob ? participant.dob|date('n/j/Y') : '--' }}</dd>
                        </dl>
                    </div>
                </div>
                <div class="panel-body">
                    {{ form_start(sampleFinalizeForm, { attr: { class: 'disable-enter prevent-resubmit'} }) }}
                    {{ form_errors(sampleFinalizeForm) }}
                    <div class="form-group">
                        {{ form_label(sampleFinalizeForm[sampleCode ~'CollectedTs']) }}
                        {{ form_widget(sampleFinalizeForm[sampleCode ~'CollectedTs']) }}
                    </div>
                    <hr>
                    {% if order.orderType == 'urine' %}
                        <label>
                            Color and Clarity
                            <span class="toggle-help-image" data-img="{{ asset('img/nph/urine_color_clarity_chart.png') }}">
                            <i class="fa fa-question-circle" aria-hidden="true"></i><span class="sr-only">Help</span>
                        </span>
                        </label>
                        <div class="row">
                            <div class="form-group col-sm-6">
                                {{ form_label(sampleFinalizeForm['urineColor']) }}
                                {{ form_widget(sampleFinalizeForm['urineColor']) }}
                            </div>
                            <div class="form-group col-sm-6">
                                {{ form_label(sampleFinalizeForm['urineClarity']) }}
                                {{ form_widget(sampleFinalizeForm['urineClarity']) }}
                            </div>
                        </div>
                        <hr>
                    {% endif %}
                    <label>Aliquot</label>
                    <table class="table table-samples">
                        <thead>
                        <tr>
                            <td class="col-md-5">Matrix Aliquot Tube/Aliquot Container</td>
                            <td class="col-md-3">Aliquot Time</td>
                            <td class="col-md-2">Volume</td>
                            <td class="col-md-1"></td>
                            <td class="col-md-1"></td>
                        </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="4" class="aliquot-barcode-error text-danger"></td></tr>
                            {% for aliquotCode, aliquot in aliquots %}
                                <tr id="aliquots_fields_list_{{ aliquotCode }}"
                                    data-aliquot-id="{{ aliquotCode }}"
                                    data-aliquot-units="{{ aliquot['units'] }}"
                                    data-code-prototype="{{ form_widget(sampleFinalizeForm[aliquotCode].vars
                                    .prototype)|e }}"
                                    data-ts-prototype="{{ form_widget(sampleFinalizeForm[aliquotCode ~ 'AliquotTs'].vars
                                    .prototype)|e }}"
                                    data-volume-prototype="{{ form_widget(sampleFinalizeForm[aliquotCode ~ 'Volume'].vars
                                    .prototype)|e }}"
                                    data-widget-tags='<tr class="aliquots-row-{{ aliquotCode }}"></tr>'
                                    data-widget-counter="{{ sampleFinalizeForm[aliquotCode]|length }}">
                                    <td colspan="4">
                                        {{ aliquot['container'] }}
                                    </td>
                                </tr>
                                {% set sampleDataCount = sampleData[aliquotCode] is defined ?
                                    sampleData[aliquotCode]|length : 0 %}
                                {% set aliquotCount = max(aliquot['expectedAliquots'], sampleDataCount) %}
                                {% for i in range(0, aliquotCount - 1) %}
                                    {% if sampleFinalizeForm[aliquotCode][i] is defined %}
                                    <tr class="aliquots-row-{{ aliquotCode }}" id="aliquots_{{ aliquotCode }}_{{ i }}">
                                        <td>
                                            {{ form_widget(sampleFinalizeForm[aliquotCode][i]) }}
                                        </td>
                                        <td style="position: relative;">
                                            {{ form_widget(sampleFinalizeForm[aliquotCode ~ 'AliquotTs'][i]) }}
                                        </td>
                                        <td>
                                            {{ form_widget(sampleFinalizeForm[aliquotCode ~ 'Volume'][i]) }}
                                        </td>
                                        <td>
                                            {{ aliquot['units'] }}
                                        </td>
                                        {% if sample.finalizedTs is empty %}
                                            <td>
                                                <i class="fa fa-eraser clear-aliquot-widget" role="button"></i>
                                                {% if i != 0 %}
                                                    <i class="fa fa-trash delete-aliquot-widget" role="button"></i>
                                                {% endif %}
                                            </td>
                                        {% endif %}
                                    </tr>
                                    {% endif %}
                                {% endfor %}
                                {% if sample.finalizedTs is empty %}
                                    <tr>
                                        <td>
                                            <a type="button" class="add-aliquot-widget"
                                               data-list-selector="#aliquots_fields_list_{{ aliquotCode }}">+ Add Line</a>
                                        </td>
                                    </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                    <hr>
                    <div class="form-group">
                        {{ form_label(sampleFinalizeForm[sampleCode ~ 'Notes']) }}
                        {{ form_widget(sampleFinalizeForm[sampleCode ~ 'Notes']) }}
                        {{ form_errors(sampleFinalizeForm[sampleCode ~ 'Notes']) }}
                    </div>
                    <p>
                        <button type="submit" class="btn btn-primary {% if sample.finalizedTs %} disabled {% endif
                        %}" id="sample_finalize_btn">Mark as Finalized</button>
                        <button type="button" class="btn btn-default">Cancel</button>
                    </p>
                    {{ form_end(sampleFinalizeForm) }}
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block pagejs %}
    {{ encore_entry_script_tags('nph-order') }}
    {{ encore_entry_script_tags('nph-sample-finalize') }}
{% endblock %}

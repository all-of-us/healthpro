{% extends 'base.html.twig' %}
{% import 'order/samples.html.twig' as samples %}
{% if order.type != 'saliva' %}
    {% form_theme finalizeForm 'form/simple_checkbox.html.twig' %}
{% endif %}
{% block title %}Finalize - Order {{ order.orderId }} - {% endblock %}
{% block body %}
    {% include 'order/header.html.twig' with { active: 'finalize' } %}
    {{ form_start(finalizeForm, { attr: { class: 'warn-unsaved disable-enter prevent-resubmit finalize-form' } }) }}
    {{ form_errors(finalizeForm) }}

    <div class="form-group{% if not finalizeForm.finalizedTs.vars.valid %} has-error{% endif %}" id="order_finalize"
         data-order-type="{{ order.type }}"
         data-order-site="{{ order.site }}"
         data-order-collect-time="{{ order.collectedTs.format('n/j/Y g:ia') }}"
         data-user-site="{{ siteInfo.siteId }}">
        {{ form_label(finalizeForm.finalizedTs) }}
        {{ form_widget(finalizeForm.finalizedTs) }}
        {{ form_errors(finalizeForm.finalizedTs) }}
    </div>

    <div class="form-group{% if not finalizeForm.finalizedSamples.vars.valid %} has-error{% endif %}">
        {{ form_label(finalizeForm.finalizedSamples) }}
        {% if order.type == 'saliva' %}
            {{ form_widget(finalizeForm.finalizedSamples) }}
        {% else %}
            {{ samples.form_widget(finalizeForm.finalizedSamples, order.disabled ? false : true, samplesInfo, version) }}
        {% endif %}
        {{ form_errors(finalizeForm.finalizedSamples) }}
    </div>

    {% if finalizeForm.fedexTracking is defined %}
        <ul class="nav nav-tabs">
            <li role="presentation" class="active"><a href="#" id="enable-number">
                    <i class="fa fa-keyboard-o" aria-hidden="true"></i>
                    Enter tracking number
                </a></li>
            <li role="presentation"><a href="#" id="enable-barcode">
                    <i class="fa fa-barcode" aria-hidden="true"></i>
                    Scan barcode
                </a></li>
        </ul>
        <br />
        <div class="row">
            <div class="col-xs-6" id="fedex-barcode" style="display:none">
                <div class="form-group">
                    <label class="control-label" for="fedex_barcode_first">FedEx or UPS barcode</label>
                    <input type="text" id="fedex_barcode_first" class="form-control">
                </div>
                <div class="form-group">
                    <label class="control-label" for="fedex_barcode_second">Verify barcode</label>
                    <input type="text" id="fedex_barcode_second" class="form-control">
                </div>
            </div>
            <div class="col-xs-12" id="fedex-number">
                {{ form_row(finalizeForm.fedexTracking) }}
            </div>
        </div>
        <hr />
    {% endif %}

    <div class="form-group{% if not finalizeForm.finalizedNotes.vars.valid %} has-error{% endif %}">
        {{ form_label(finalizeForm.finalizedNotes) }}
        <span class="toggle-help-image">
            <i class="fa fa-question-circle" aria-hidden="true"></i><span class="sr-only">Help</span>
        </span>
        {{ form_widget(finalizeForm.finalizedNotes) }}
        <small class="text-warning">Comments entered in this field must be transmitted to the Biobank via reconciliation reporting. You may not enter any participant identifying information here.</small>
        {{ form_errors(finalizeForm.finalizedNotes) }}
    </div>
    {{ form_rest(finalizeForm) }}
    {% if not order.disabled %}
        <p>
            <button type="submit" {% if hasErrors %} class="btn btn-default" disabled="disabled" {% else %} class="btn btn-primary" {% endif %}>
                Save and mark as finalized
            </button>
        </p>
    {% endif %}
    {{ form_end(finalizeForm) }}
    {% if order.status == 'unlock' %}
        {{ form_start(revertForm, { 'action': path('order_revert', { participantId: participant.id, orderId: order.id }), 'method': 'POST', attr: { class: 'revert-form disable-enter prevent-resubmit' }}) }}
        {{ form_errors(revertForm) }}
        {{ form_end(revertForm) }}
    {% endif %}
{% endblock %}

{% block pagejs %}
    {{ encore_entry_script_tags('order-sub') }}
    {{ encore_entry_script_tags('order-finalize') }}
{% endblock %}

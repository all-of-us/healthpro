{% extends 'base.html.twig' %}
{% block title %}Physical Measurements - {% endblock %}
{% block body %}
    <div id="physicalEvaluation">
        {% if displayEhrBannerMessage and ehrProtocolBannerMessage is not empty %}
            <div class="alert alert-warning">{{ ehrProtocolBannerMessage }}</div>
        {% endif %}
        <div class="page-header">
            <h2>
                <i class="fa fa-clipboard" aria-hidden="true"></i>
                {% if evaluation %}
                    {{ evaluation.created_ts|date('n/j/Y', app.userTimezone) }}
                {% else %}
                    New Physical Measurements
                {% endif %}
                <small><a href="{{ path('participant', { id: participant.id }) }}">{{ participant.lastName }}, {{ participant.firstName }}</a></small>
                {% if evaluation %}
                    {% if evaluation.canCancel %}
                        <a href="{{ path('evaluationModify', { participantId: participant.id, evalId: evaluation.id, type: 'cancel' }) }}" class="btn btn-sm btn-danger">Cancel</a>
                    {% elseif evaluation.canRestore %}
                        <a href="{{ path('evaluationModify', { participantId: participant.id, evalId: evaluation.id, type: 'restore' }) }}" class="btn btn-sm btn-success">Restore</a>
                    {% endif %}
                {% endif %}
            </h2>
        </div>
        <dl class="dl-horizontal">
            <dt>Name</dt>
            <dd>{{ participant.lastName }}, {{ participant.firstName }}</dd>
            <dt>Participant ID</dt>
            <dd>{{ participant.id }}</dd>
            <dt>DOB</dt>
            <dd>{{ participant.dob ? participant.dob|date('n/j/Y') }}</dd>
            <dt>Gender Identity</dt>
            <dd>{{ participant.genderIdentity }}</dd>
            {% if evaluation %}
                <dt>Updated</dt>
                <dd>{{ evaluation.updated_ts|date('n/j/Y g:ia', app.userTimezone) }}</dd>
                {% if evaluation.version != latestVersion %}
                    <dt>Version</dt>
                    <dd>{{ evaluation.version }} <small class="text-muted">(latest version is {{ latestVersion }})</small></dd>
                {% endif %}
            {% endif %}
            <dt>Paired Awardee</dt>
            <dd>{{ participant.awardee ? app.getAwardeeDisplayName(participant.awardee) : '(not paired)' }}</dd>
        </dl>
        {% if evaluation and evaluation.eh_type == 'cancel' %}
            <div class="alert alert-danger">
                <i class="fa fa-info-circle" aria-hidden="true"></i>
                <strong>Cancelled by {{ app.getUserEmailById(evaluation.eh_user_id)|default('Unknown') }} at {{ app.getSiteDisplayName(evaluation.eh_site) }} on {{ evaluation.eh_created_ts|date('n/j/Y \\a\\t g:ia', app.userTimezone) }}</strong>
                {% if evaluation.reasonDisplayText is not empty %}
                    <br/><strong>Reason:</strong> {{ evaluation.reasonDisplayText }}
                {% endif %}
            </div>
        {% endif %}
        {% if evaluation and evaluation.parent_id is not empty and evaluation.rdr_id is empty %}
            <div class="alert alert-warning">
                <i class="fa fa-check-circle" aria-hidden="true"></i>
                <strong>Unlocked for editing by {{ app.getUserEmailById(evaluation.user_id)|default('Unknown') }} at {{ app.getSiteDisplayName(evaluation.site) }} on {{ evaluation.created_ts|date('n/j/Y \\a\\t g:ia', app.userTimezone) }}</strong>
            </div>
        {% endif %}
        {% if evaluation %}
            {% if evaluation.rdr_id %}
                <div class="alert alert-success">
                    <i class="fa fa-check-circle" aria-hidden="true"></i>
                    <strong>Finalized by {{ app.getUserEmailById(evaluation.finalized_user_id)|default('Unknown') }} at {{ app.getSiteDisplayName(evaluation.finalized_site) }} on {{ evaluation.finalized_ts|date('n/j/Y \\a\\t g:ia', app.userTimezone) }}</strong>
                    <a class="btn btn-success btn-xs pull-right" href="{{ path('evaluationSummary', { participantId: participant.id, evalId: evaluation.id }) }}" target="_blank">Summary</a>
                </div>
            {% elseif evaluation.finalized_ts and evaluation.rdr_id is empty %}
                <div class="alert alert-danger well-sm">
                    <i class="fa fa-info-circle" aria-hidden="true"></i>
                    <strong>An error occurred while finalizing this physical measurements. Please try again.</strong>
                </div>
            {% endif %}
        {% endif %}

        {{ form_start(evaluationForm, { attr: { class: 'warn-unsaved disable-enter prevent-resubmit' } }) }}
            {{ form_errors(evaluationForm) }}
            {% if showAutoModification %}
                <div class="row">
                    <div class="col-sm-6 col-sm-offset-3">
                        <div class="panel panel-danger">
                            <div class="panel-heading">
                                <h3 class="panel-title">
                                    <i class="fa fa-forward" aria-hidden="true"></i>
                                    Or, auto-fill modifications and finalize
                                </h3>
                            </div>
                            <div class="panel-body">
                                <p>
                                    If physical measurements are incomplete due to refusal or a medical emergency, auto-fill missing fields with protocol modifications and finalize.
                                </p>
                                <p>
                                    <strong>Finalize physical measurements early due to:</strong>
                                </p>
                                <div class="row">
                                    <div class="col-xs-6">
                                        <button type="submit" name="finalize" class="autofill-protocol-modification btn btn-block btn-default" data-reason="refusal" onclick="return confirm('Are you sure you want to finalize these physical measurements?');">Refusal</button>
                                    </div>
                                    <div class="col-xs-6">
                                        <button type="submit" name="finalize" class="autofill-protocol-modification btn btn-block btn-default" data-reason="emergency" onclick="return confirm('Are you sure you want to finalize these physical measurements?');">Urgent/Emergent Event</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}

            {% if not evaluation or not evaluation.rdr_id %}
                <div id="evaluationAffixSave">
                    {% if not evaluation or not evaluation.finalized_ts %}
                        <button type="submit" class="btn btn-primary btn-xs" name="save">Save</button>
                    {% endif %}
                    <button type="submit" class="btn btn-success btn-xs" name="finalize" onclick="return confirm('Are you sure you want to finalize these physical measurements?');">Save and Finalize</button>
                </div>
            {% endif %}

            {% if schema.template is defined %}
                {% include 'evaluationform/' ~ schema.template ~ '.html.twig' %}
            {% else %}
                {% include 'evaluationform/0.1.html.twig' %}
            {% endif %}

            {{ form_rest(evaluationForm) }}

            {% if evaluation and evaluation.rdr_id %}
                <p>
                    <a href="{{ path('participant', { id: participant.id }) }}" class="btn btn-default">Return to participant</a>
                    {% if evaluation.eh_type != 'cancel' %}
                        <button type="submit" class="btn btn-warning" name="copy" onclick="return confirm('Are you sure you want to copy these physical measurements?');">Copy</button>
                    {% endif %}
                </p>
            {% else %}
                <p>
                    <a href="{{ path('participant', { id: participant.id }) }}" class="btn btn-default">Cancel</a>
                    {% if not evaluation or not evaluation.finalized_ts %}
                        <button type="submit" class="btn btn-primary" name="save">Save</button>
                    {% endif %}
                    <button type="submit" class="btn btn-success pull-right" name="finalize" onclick="return confirm('Are you sure you want to finalize these physical measurements?');">Save and Finalize</button>
                </p>
            {% endif %}
        {{ form_end(evaluationForm) }}
        {% if evaluation and evaluation.parent_id and evaluation.finalized_ts is empty %}
            {{ form_start(revertForm, { 'action': path('evaluationRevert', { participantId: participant.id, evalId: evaluation.id }), 'method': 'POST', attr: { class: 'eval-revert-form disable-enter prevent-resubmit' }}) }}
            {{ form_errors(revertForm) }}
            {{ form_end(revertForm) }}
        {% endif %}
    </div>
{% endblock %}

{% block pagejs %}
{{ webpack_entry('physical-measurements-' ~ (schema.template|default('-0.1')) , 'js') }}
<script>
$(document).ready(function() {
    var evalView = new PMI.views['PhysicalEvaluation{% if schema.template is defined %}-{{ schema.template }}{% else %}-0.1{% endif %}']({
        el: $("#physicalEvaluation"),
        warnings: {{ warnings|json_encode|raw }},
        conversions: {{ conversions|json_encode|raw }},
        finalized: {{ (evaluation and evaluation.finalized_ts)|json_encode|raw }}
    });
    $('#evaluationAffixSave')
        .affix({
            offset: {
                top: 100,
                bottom: $(window).height()
            }
        })
        .width($('#physicalEvaluation').width());
});
</script>
{% endblock %}

{% extends 'base.html.twig' %}
{% block title %}Participant {{ participant.id }} - {% endblock %}
{% block body %}
{% if hasNoParticipantAccess %}
    <div class="row">
        <div class="col-sm-8 col-sm-push-2 col-lg-6 col-lg-push-3">
            <div class="panel panel-danger">
                <div class="panel-heading">
                    <h3 class="panel-title"><i class="fa" aria-hidden="true"></i>Warning</h3>
                </div>
                <div class="panel-body">
                    The participant you have selected is either unpaired or paired with another enrollment site. Please verify that this is the correct participant. By continuing, you acknowledge that you have a valid need to access this record. Access to this record will be audited and is subject to review. Unauthorized access to records may result in loss of access to HealthPro.
                </div>
                <div class="modal-footer text-right">
                    <form action="" method="post">
                        {{ form_widget(agreeForm) }}
                        <button type="submit" class="btn btn-success">Acknowledge</button>
                        <a href="{{ path('participants') }}" class="btn btn-default">Cancel</a>
                    </form>
                </div>
            </div>
        </div>
    </div> 
{% else %}
    <div class="page-header">
        <h2>{{ participant.lastName }}, {{ participant.firstName }} <small>{{ participant.shortId }}</small></h2>
    </div>

    <div class="row">
        <div class="col-sm-6">
          {% include 'partials/participant-dl.html.twig' %}
        </div>
        <div class="col-sm-6 text-center">
            <svg id="participant-barcode"></svg>
        </div>
    </div>
    {% if cacheEnabled %}
        <div class="row">
            <div class="col-sm-12 text-center">
                <small>
                    Last updated: {{ participant.cacheTime ? participant.cacheTime|date('g:ia', app.userTimezone) }}
                    <a href="{{ path('participant', { id: participant.id, refresh: 1 }) }}" style="margin-left: 6px"><i class="fa fa-refresh" aria-hidden="true"></i> refresh</a>
                </small>
            </div>
        </div>
    {% endif %}

    {% if participant.status or canViewDetails %}
        <div id="participant-consent-status">
            <div class="status-block">
                <strong>General Consent</strong>
                {% if participant.consentForStudyEnrollment == 'SUBMITTED' %}
                    <i class="fa fa-check text-success" aria-hidden="true"></i>
                    {{ participant.consentForStudyEnrollmentTime ? participant.consentForStudyEnrollmentTime|date('n/j/Y', app.userTimezone) }}
                {% else %}
                    <i class="fa fa-times text-danger" aria-hidden="true"></i>
                {% endif %}
                <br />
            </div>
            <div class="status-block">
                <strong>EHR Consent</strong>
                {% if participant.consentForElectronicHealthRecords == 'SUBMITTED' %}
                    <i class="fa fa-check text-success" aria-hidden="true"></i>
                    {{ participant.consentForElectronicHealthRecordsTime ? participant.consentForElectronicHealthRecordsTime|date('n/j/Y', app.userTimezone) }}
                {% else %}
                    <i class="fa fa-times text-danger" aria-hidden="true"></i>
                    {{ participant.consentForElectronicHealthRecordsTime ? participant.consentForElectronicHealthRecordsTime|date('n/j/Y', app.userTimezone) : '(not completed)' }}
                {% endif %}
                <br />
            </div>
            <div class="status-block">
                <strong>CABoR Consent</strong> <span title="California Research Subjects' Bill of Rights is required for participants only by enrollment sites in California" data-toggle="tooltip"><span class="sr-only">What is CABoR?</span><i class="fa fa-question-circle text-info"></i></span>
                {% if participant.consentForCABoR == 'SUBMITTED' %}
                    <i class="fa fa-check text-success" aria-hidden="true"></i>
                    {{ participant.consentForCABoRTime ? participant.consentForCABoRTime|date('n/j/Y', app.userTimezone) }}
                {% else %}
                    <i class="fa fa-times text-danger" aria-hidden="true"></i>
                    {{ participant.consentForCABoRTime ? participant.consentForCABoRTime|date('n/j/Y', app.userTimezone) : '(not completed)' }}
                {% endif %}
                <br />
            </div>
        </div>
    {% endif %}

    <div role="tabpanel">
        <ul class="nav nav-tabs" role="tablist">
            <li role="presentation" class="active">
                <a href="#inperson" aria-controls="inperson" role="tab" data-toggle="tab">In-Person Enrollment</a>
            </li>
            {% if canViewDetails %}
                <li role="presentation">
                    <a href="#details" aria-controls="tab" role="tab" data-toggle="tab">Participant Details</a>
                </li>
            {% else %}
                <li role="presentation" class="disabled">
                    <a href="#" title="Details not available because participant is either withdrawn, unpaired, or paired with another enrollment site" data-toggle="tooltip" data-placement="bottom">Participant Details</a>
                </li>
            {% endif %}
        </ul>
        <br />
        <div class="tab-content">
            <div role="tabpanel" class="tab-pane active" id="inperson">
                {% if participant.status and not app.isTestSite %}
                    <div class="row">
                        <div class="col-sm-6 {{ app.isDVType ? 'col-lg-4' : 'col-lg-6' }}">
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <h3 class="panel-title"><i class="fa fa-clipboard" aria-hidden="true"></i> Physical Measurements</h3>
                                </div>
                                <div class="panel-body">
                                    {% for evaluation in evaluations %}
                                        {% if loop.index == 6 %}
                                            <div id="evaluation-overflow">
                                        {% endif %}
                                        <a href="{{ path('evaluation', { participantId: participant.id, evalId: evaluation.id }) }}" class="btn btn-block btn-lg btn-default">
                                            {{ evaluation.created_ts|date('D n/j/Y', app.userTimezone) }}<br />
                                            <small class="text-muted">
                                                {% if evaluation.finalized_ts %}
                                                    <span class="label label-success">Finalized</span> {{ evaluation.finalized_ts|date('n/j/Y g:ia', app.userTimezone) }}
                                                {% else %}
                                                    <span class="label label-default">Updated</span> {{ evaluation.updated_ts|date('n/j/Y g:ia', app.userTimezone) }}
                                                {% endif %}
                                            </small>
                                        </a>
                                    {% endfor %}
                                    {% if evaluations|length > 5 %}
                                        </div> {# close .evaluation-overflow div above #}
                                        <a href="#" class="btn btn-block btn-lg btn-default" id="evaluation-overflow-show">
                                            <i class="fa fa-chevron-circle-down" aria-hidden="true"></i> Show all
                                        </a>
                                    {% endif %}
                                    <a href="{{ path('evaluation', { participantId: participant.id }) }}" class="btn btn-block btn-lg btn-default">
                                        <i class="fa fa-plus-circle" aria-hidden="true"></i>
                                        {% if evaluations|length > 0 %}
                                            New
                                        {% else %}
                                            Start
                                        {% endif %}
                                        Physical Measurements
                                    </a>
                                </div>
                            </div>
                        </div>

                        <div class="col-sm-6 {{ app.isDVType ? 'col-lg-4' : 'col-lg-6' }}">
                            {% include 'partials/participant-orders-list.html.twig' %}
                        </div>
                        {% if app.isDVType %}
                            <div class="col-sm-6 col-lg-4">
                                <div class="panel panel-default">
                                    <div class="panel-heading">
                                        <h3 class="panel-title"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> Document Unanticipated Problems</h3>
                                    </div>
                                    <div class="panel-body">
                                        {% for problem in problems %}
                                            {% if loop.index == 6 %}
                                                <div id="problem-overflow">
                                            {% endif %}
                                            <a href="{{ path('problemForm', { participantId: participant.id, problemId: problem.id }) }}" class="btn btn-block btn-lg btn-default">
                                                {{ problem.updated_ts|date('D n/j/Y', app.userTimezone) }}
                                                <br />
                                                <small class="text-muted">
                                                    {% if problem.finalized_ts %}
                                                        <span class="label label-success">Finalized</span>
                                                        {{ problem.finalized_ts|date('n/j/Y g:ia', app.userTimezone) }}
                                                        <br />
                                                        {% if problem.comment_count > 0 %}
                                                            <span class="label label-default">{{ problem.comment_count }} comment{{ problem.comment_count > 1 ? 's' }}</span> {{ problem.last_comment_ts|date('n/j/Y g:ia', app.userTimezone) }}
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="label label-danger">Draft</span>
                                                        {{ problem.updated_ts|date('n/j/Y g:ia', app.userTimezone) }}
                                                    {% endif %}
                                                </small>
                                            </a>
                                        {% endfor %}
                                        {% if problems|length > 5 %}
                                            </div>
                                            <a href="#" class="btn btn-block btn-lg btn-default" id="problem-overflow-show">
                                                <i class="fa fa-chevron-circle-down" aria-hidden="true"></i> Show all
                                            </a>
                                        {% endif %}
                                        <a href="{{ path('problemForm', { participantId: participant.id }) }}" class="btn btn-block btn-lg btn-default">
                                            <i class="fa fa-plus-circle" aria-hidden="true"></i>
                                            New Unanticipated Problem
                                        </a>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                {% else %}
                    {% if app.isTestSite %}
                        {% set errorTitle = 'Test user' %}
                        {% set errorMessage = 'Data collection and entry for test users are prohibited in the production environment.' %}
                    {% elseif participant.statusReason == 'test-participant' %}
                        {% set errorTitle = 'This is not a real participant' %}
                        {% set errorMessage = 'Data collection and entry for test participants are prohibited in the production environment. You may not create a biobank order or collect physical measurements for this participant.' %} 
                    {% elseif participant.statusReason == 'basics' %}
                        {% set errorTitle = 'The Basics survey not complete' %}
                        {% set errorMessage = 'This participant has consented but has not completed "The Basics" survey in the participant app and is therefore ineligible for physical measurements and biospecimen collection. Please direct the participant to complete "The Basics" survey in the participant application to enable in person enrollment or contact the help desk if needed.' %}
                    {% elseif participant.statusReason == 'withdrawal' %}
                        {% set errorTitle = 'Withdrawn participant' %}
                        {% set errorMessage = 'This participant has withdrawn from the All of Us Research Program. No new data can be collected or sent for this participant. Staff must also follow all site-specific SOPs to ensure all All of Us Research Program data are removed from all local systems for this participant.' %}
                    {% else %}
                        {% set errorTitle = 'Consent not complete' %}
                        {% set errorMessage = 'This participant has not completed consent for enrollment.' %}
                    {% endif %}
                    <div class="row">
                        <div class="col-sm-8 col-sm-push-2 col-lg-6 col-lg-push-3">
                            <div class="panel panel-danger">
                                <div class="panel-heading">
                                    <h3 class="panel-title"><i class="fa fa-times-circle" aria-hidden="true"></i> {{ errorTitle }}</h3>
                                </div>
                                <div class="panel-body">
                                    {{ errorMessage }}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
            {% if canViewDetails %}
                <div role="tabpanel" class="tab-pane" id="details">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <h3 class="panel-title">Contact</h3>
                                </div>
                                <div class="panel-body">
                                    <dl class="dl-vertical">
                                        <dt>Language</dt>
                                        <dd>{{ participant.language|default('--') }}</dd>
                                        <dt>Contact Method</dt>
                                        <dd>{{ participant.recontactMethod|default('--') }}</dd>
                                        <dt>Address</dt>
                                        <dd>{{ participant.getAddress(true)|default('--')|nl2br }}</dd>
                                        <dt>Email</dt>
                                        <dd>{{ participant.email|default('--') }}</dd>
                                        <dt>Phone</dt>
                                        <dd>{{ participant.phoneNumber|default('--') }}</dd>
                                    </dl>
                                </div>
                            </div>

                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <h3 class="panel-title">Demographics</h3>
                                </div>
                                <div class="panel-body">
                                    <dl class="dl-vertical">
                                        <dt>Age</dt>
                                        <dd>{{ participant.getAge()|default('--') }}</dd>
                                        <dt>Sex</dt>
                                        <dd>{{ participant.sex|default('--') }}</dd>
                                        <dt>Gender Identity</dt>
                                        <dd>{{ participant.genderIdentity|default('--') }}</dd>
                                        <dt>Race/Ethnicity</dt>
                                        <dd>{{ participant.race|default('--') }}</dd>
                                        <dt>Education</dt>
                                        <dd>{{ participant.education|default('--') }}</dd>
                                    </dl>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <h3 class="panel-title">PPI Survey Completion</h3>
                                </div>
                                <div class="panel-body">
                                    <dl class="dl-horizontal">
                                        <dt>Required Complete?</dt>
                                        <dd>
                                            {% if participant.numCompletedBaselinePPIModules == 3 %}
                                                <i class="fa fa-check text-success" aria-hidden="true"></i>
                                            {% else %}
                                                <i class="fa fa-times text-danger" aria-hidden="true"></i>
                                            {% endif %}
                                        </dd>
                                        <dt>Number Complete</dt>
                                        <dd>{{ participant.numCompletedPPIModules }}</dd>
                                    </dl>
                                    <div class="text-center">
                                        {% for field, label in surveys %}
                                            <div class="participant-detail-status">
                                                <strong>{{ label }}</strong>
                                                {% if attribute(participant, 'questionnaireOn' ~ field) == 'SUBMITTED' %}
                                                    <i class="fa fa-check text-success" aria-hidden="true"></i>
                                                    {% if attribute(participant, 'questionnaireOn' ~ field ~ 'Time') %}
                                                        <small>{{ attribute(participant, 'questionnaireOn' ~ field ~ 'Time')|date('m/d/Y', app.userTimezone) }}</small>
                                                    {% endif %}
                                                {% else %}
                                                    <i class="fa fa-times text-danger" aria-hidden="true"></i>
                                                    <small>(not completed)</small>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <h3 class="panel-title">In-Person Enrollment</h3>
                                </div>
                                <div class="panel-body">
                                    <div class="text-center">
                                        <div class="participant-detail-status">
                                            <strong>Paired Awardee</strong>
                                            {% if participant.awardee %}
                                                <i class="fa fa-check text-success" aria-hidden="true"></i>
                                            {% else %}
                                                <i class="fa fa-times text-danger" aria-hidden="true"></i>
                                                <small>(not paired)</small>
                                            {% endif %}
                                        </div>
                                        <br/>
                                        {% if participant.awardee %}
                                            <samp>{{ app.getAwardeeDisplayName(participant.awardee) }}</samp>
                                        {% endif %}
                                    </div>
                                    <hr />
                                    <div class="text-center">
                                        <div class="participant-detail-status">
                                            <strong>Paired Organization</strong>
                                            {% if participant.organization %}
                                                <i class="fa fa-check text-success" aria-hidden="true"></i>
                                            {% else %}
                                                <i class="fa fa-times text-danger" aria-hidden="true"></i>
                                                <small>(not paired)</small>
                                            {% endif %}
                                        </div>
                                        <br/>
                                        {% if participant.organization %}
                                            <samp>{{ app.getOrganizationDisplayName(participant.organization) }}</samp>
                                        {% endif %}
                                    </div>
                                    <hr />
                                    <div class="text-center">
                                        <div class="participant-detail-status">
                                            <strong>Paired Site</strong>
                                            {% if participant.siteSuffix %}
                                                <i class="fa fa-check text-success" aria-hidden="true"></i>
                                            {% else %}
                                                <i class="fa fa-times text-danger" aria-hidden="true"></i>
                                                <small>(not paired)</small>
                                            {% endif %}
                                        </div>
                                        <br/>
                                        {% if participant.siteSuffix %}
                                            Location: <samp>{{ app.getSiteDisplayName(participant.siteSuffix) }}</samp>
                                        {% endif %}
                                    </div>
                                    <hr />
                                    <div class="text-center">
                                        <div class="participant-detail-status">
                                            <strong>Physical Measurements</strong>
                                            {% if participant.physicalMeasurementsStatus == 'COMPLETED' %}
                                                <i class="fa fa-check text-success" aria-hidden="true"></i>
                                                {% if participant.physicalMeasurementsFinalizedTime %}
                                                    <small>{{ participant.physicalMeasurementsFinalizedTime|date('m/d/Y', app.userTimezone) }}</small>
                                                {% endif %}
                                            {% else %}
                                                <i class="fa fa-times text-danger" aria-hidden="true"></i>
                                                <small>(not completed)</small>
                                            {% endif %}
                                        </div>
                                        <br />
                                        {% if participant.evaluationFinalizedSite %}
                                            Location: <samp>{{ app.getSiteDisplayName(participant.evaluationFinalizedSite) }}</samp>
                                        {% endif %}
                                    </div>
                                    <hr />
                                    <dl class="dl-horizontal dl-horizontal-lg">
                                        <dt>Biospecimens Received</dt>
                                        <dd>
                                            {% if participant.numBaselineSamplesArrived >= 7 %}
                                                <i class="fa fa-check text-success" aria-hidden="true"></i>
                                            {% endif %}
                                            {{ participant.numBaselineSamplesArrived }}
                                        </dd>
                                        <dt>Samples for DNA Received?</dt>
                                        <dd>
                                            {% if participant.samplesToIsolateDNA == 'RECEIVED' %}
                                                <i class="fa fa-check text-success" aria-hidden="true"></i>
                                            {% else %}
                                                <i class="fa fa-times text-danger" aria-hidden="true"></i>
                                            {% endif %}
                                        </dd>
                                    </dl>
                                    <div class="text-center">
                                        {% for field, label in samples %}
                                            {% set break = false %}
                                            {% for sampleAlias in samplesAlias if not break %}
                                                {% if attribute(sampleAlias, field) is defined  and attribute(participant, 'sampleStatus' ~ attribute(sampleAlias, field)) == 'RECEIVED' %}
                                                    {% set field = attribute(sampleAlias, field) %}
                                                    {% set break = true %}
                                                {% endif %}
                                            {% endfor %}
                                            <div class="participant-detail-status">
                                                <strong>{{ label }}</strong>
                                                {% if attribute(participant, 'sampleStatus' ~ field) == 'RECEIVED' %}
                                                    <i class="fa fa-check text-success" aria-hidden="true"></i>
                                                    {% if attribute(participant, 'sampleStatus' ~ field ~ 'Time') %}
                                                        <small>{{ attribute(participant, 'sampleStatus' ~ field ~ 'Time')|date('m/d/Y', app.userTimezone) }}</small>
                                                    {% endif %}
                                                {% else %}
                                                    <i class="fa fa-times text-danger" aria-hidden="true"></i>
                                                    <small>(not received)</small>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                        <br />
                                        {% if participant.orderCreatedSite %}
                                            Location: <samp>{{ app.getSiteDisplayName(participant.orderCreatedSite) }}</samp>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
{% endif %}
{% endblock %}

{% block pagejs %}
<script>
$(document).ready(function() {
    $('#order-overflow-show').on('click', function(e) {
        $(this).hide();
        $('#order-overflow').show();
        e.preventDefault();
    });
    $('#evaluation-overflow-show').on('click', function(e) {
        $(this).hide();
        $('#evaluation-overflow').show();
        e.preventDefault();
    });
    $('#problem-overflow-show').on('click', function(e) {
        $(this).hide();
        $('#problem-overflow').show();
        e.preventDefault();
    });
    JsBarcode("#participant-barcode", {{ participant.id|json_encode|raw }}, {
        width: 2,
        height: 50,
        displayValue: true
    });
});
</script>
{% endblock %}

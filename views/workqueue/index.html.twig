{% extends 'base.html.twig' %}
{% block title %}Participant Work Queue - {% endblock %}
{% block bodycontainer %}container-fluid{% endblock %}
{% block body %}
    <div class="page-header">
        <h2>Participant Work Queue</h2>
    </div>
    <div class="well">
        <p><strong>Filters</strong> <small><a href="{{ path('workqueue_index') }}">reset</a></p>
        <form class="form-inline" id="filters">
            {% for name, filter in filters %}
                <select name="{{ name }}" class="form-control input-sm">
                    <option value="">-- {{ filter.label }} --</option>
                    {% for label, value in filter.options %}
                        <option value="{{ value }}"{% if params[name]|default(false) == value %} selected="selected"{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            {% endfor %}
        </form>
    </div>
    <div class="pull-right">
        <button data-href="{{ path('workqueue_export', params) }}" class="btn btn-xs btn-default export"><i class="fa fa-download" aria-hidden="true"></i> Export</button>
    </div>
    <h4>{{ participants|length|number_format }}{{ params|length > 0 ? ' matching' : '' }} participant{{ participants|length == 1 ? '' : 's'}} at {{ app.session.get('site').name }}</h4>
    <table class="table table-striped table-bordered table-small">
        <thead>
            <tr>
                <th rowspan="2">Last Name</th>
                <th rowspan="2">First Name</th>
                <th rowspan="2">Preferred Contact</th>
                <th rowspan="2">Consent Date</th>
                <th colspan="{{ surveys|length }}" class="topheader multiheader-survey">PPI Survey Completion</th>
                <th colspan="4" class="topheader multiheader-status">HealthPro Status</th>
            </tr>
            <tr>
                {% for field, label in surveys %}
                    <th class="secondaryheader multiheader-survey">{{ label }}</th>
                {% endfor %}
                <th class="secondaryheader multiheader-status">Phys Meas</th>
                <th class="secondaryheader multiheader-status">Biobank</th>
                <th class="secondaryheader multiheader-status">Membership</th>
                <th class="secondaryheader multiheader-status">Consent</th>
            </tr>
        </thead>
        <tbody>
            {% for participant in participants %}
                <tr>
                    <td>{{ participant.lastName }}</td>
                    <td>{{ participant.firstName }}</td>
                    <td>{{ participant.zipCode }}</td>
                    <td>
                        {{ participant.consentForStudyEnrollmentTime|date('m/d/Y') }}
                    </td>
                    {% for field, label in surveys %}
                        <td class="text-center">
                            {% if attribute(participant, 'questionnaireOn' ~ field)|default('') == 'SUBMITTED' %}
                                <i class="fa fa-check text-success" aria-hidden="true"></i>
                            {% else %}
                                <i class="fa fa-times text-danger" aria-hidden="true"></i>
                            {% endif %}
                        </td>
                    {% endfor %}

                    <td class="text-center">
                        {% if participant.physicalMeasurementsStatus == 'SUBMITTED' %}
                            <i class="fa fa-check text-success" aria-hidden="true"></i>
                        {% else %}
                            <i class="fa fa-times text-danger" aria-hidden="true"></i>
                        {% endif %}
                    </td>
                    <td class="text-center">
                        <strong class="text-{{ participant.numBaselineSamplesArrived == 7 ? 'success' : 'danger' }}">{{ participant.numBaselineSamplesArrived }}/7</strong>
                    </td>
                    <td>{{ participant.membershipTier }}</td>
                    <td>{{ participant.consentForStudyEnrollment }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    <p class="text-right">
        <button data-href="{{ path('workqueue_export', params) }}" class="btn btn-xs btn-default export"><i class="fa fa-download" aria-hidden="true"></i> Export</button>
    </p>
{% endblock %}

{% block pagejs %}
<script>
$(document).ready(function() {
    $('#filters select').change(function() {
        $('#filters').submit();
    })
    $('button.export').click(function() {
        var location = $(this).data('href');
        new PmiConfirmModal({
            title: 'Attention',
            msg: 'The file you are about to download contains information that is sensitive and confidential. By clicking "accept" you agree not to distribute either the file or its contents, and to adhere to the <em>All of Us</em> Privacy and Trust Principles. A record of your acceptance will be stored at the Data and Research Center.',
            isHTML: true,
            onTrue: function() {
                window.location = location;
            },
            btnTextTrue: 'Accept'
        });
    });
});
</script>
{% endblock %}

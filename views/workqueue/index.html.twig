{% extends 'base.html.twig' %}
{% block title %}Participant Work Queue - {% endblock %}
{% block bodycontainer %}container-fluid{% endblock %}
{% block body %}
    <div class="page-header">
        <h2>Participant Work Queue</h2>
    </div>
    <div class="well">
        <p><strong>Filters</strong> <small><a href="{{ path('workqueue_index') }}">reset</a></p>
        <form class="form-inline" id="filters">
            {% for name, filter in filters %}
                <select name="{{ name }}" class="form-control input-sm">
                    <option value="">-- {{ filter.label }} --</option>
                    {% for label, value in filter.options %}
                        <option value="{{ value }}"{% if params[name]|default(false) == value %} selected="selected"{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            {% endfor %}
        </form>
    </div>
    <p class="text-right">
        <button data-href="{{ path('workqueue_export', params) }}" class="btn btn-xs btn-default export"><i class="fa fa-download" aria-hidden="true"></i> Export</button>
    </p>
    <h4>{{ participants|length|number_format }}{{ params|length > 0 ? ' matching' : '' }} participant{{ participants|length == 1 ? '' : 's'}} at {{ app.session.get('site').name }}</h4>
    <table class="table table-striped table-bordered dt-responsive nowrap" id="workqueue" width="100%">
        <thead>
            <tr>
                <th>Last Name</th>
                <th>First Name</th>
                <th>Preferred Contact</th>
                <th>Consent Date</th>
                {% for field, label in surveys %}
                    <th class="multiheader-survey">{{ label }}</th>
                {% endfor %}
                <th class="multiheader-status">Phys Meas</th>
                <th class="multiheader-status">Biobank</th>
                <th class="multiheader-status">Membership</th>
                <th class="multiheader-status">Consent</th>
            </tr>
        </thead>
        <tbody>
            {% for participant in participants %}
                <tr>
                    <td>{{ participant.lastName }}</td>
                    <td>{{ participant.firstName }}</td>
                    <td>{{ participant.zipCode }}</td>
                    <td>
                        {{ participant.consentForStudyEnrollmentTime|date('m/d/Y') }}
                    </td>
                    {% for field, label in surveys %}
                        <td class="text-center">
                            {% if attribute(participant, 'questionnaireOn' ~ field)|default('') == 'SUBMITTED' %}
                                <i class="fa fa-check text-success" aria-hidden="true"></i>
                            {% else %}
                                <i class="fa fa-times text-danger" aria-hidden="true"></i>
                            {% endif %}
                        </td>
                    {% endfor %}

                    <td class="text-center">
                        {% if participant.physicalMeasurementsStatus == 'SUBMITTED' %}
                            <i class="fa fa-check text-success" aria-hidden="true"></i>
                        {% else %}
                            <i class="fa fa-times text-danger" aria-hidden="true"></i>
                        {% endif %}
                    </td>
                    <td class="text-center">
                        <strong class="text-{{ participant.numBaselineSamplesArrived == 7 ? 'success' : 'danger' }}">{{ participant.numBaselineSamplesArrived }}/7</strong>
                    </td>
                    <td>{{ participant.membershipTier }}</td>
                    <td>{{ participant.consentForStudyEnrollment }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    <p class="text-right">
        <button data-href="{{ path('workqueue_export', params) }}" class="btn btn-xs btn-default export"><i class="fa fa-download" aria-hidden="true"></i> Export</button>
    </p>
{% endblock %}

{% block pagejs %}
<script>
$(document).ready(function() {
    $('#filters select').change(function() {
        $('#filters').submit();
    })
    $('button.export').click(function() {
        var location = $(this).data('href');
        new PmiConfirmModal({
            title: 'Attention',
            msg: 'The file you are about to download contains information that is sensitive and confidential. By clicking "accept" you agree not to distribute either the file or its contents, and to adhere to the <em>All of Us</em> Privacy and Trust Principles. A record of your acceptance will be stored at the Data and Research Center.',
            isHTML: true,
            onTrue: function() {
                window.location = location;
            },
            btnTextTrue: 'Accept'
        });
    });
    var table = $('#workqueue').DataTable({
        dom: 'lBrtip',
        //processing: true,
        //serverSide: true,
        //ajax: {{ path('workqueue_data')|json_encode|raw }},
        columns: [
            { name: 'lastName' },
            { name: 'firstName' },
            { name: 'contact' },
            { name: 'consent' },
            {% for field, label in surveys %}
                { name: 'ppi{{ field }}' },
            {% endfor %}
            { name: 'physicalMeasurementsStatus' },
            { name: 'biobankSamples' },
            { name: 'membershipTier' },
            { name: 'consentStatus' }
        ],
        pageLength: 25,
        buttons: [
            {
                extend: 'colvis',
                text: 'Columns <i class="fa fa-caret-down" aria-hidden="true"></i>',
                columns: ':not(:first-child):not(:nth-child(2))'
            },
            {
                extend: 'colvisGroup',
                text: 'PPI Modules',
                show: [ {% for field, label in surveys %}'ppi{{field}}:name', {% endfor %} ],
                hide: [
                    'contact:name',
                    'consent:name',
                    'physicalMeasurementsStatus:name',
                    'biobankSamples:name',
                    'membershipTier:name',
                    'consentStatus:name'
                ]
            },
            {
                extend: 'colvisGroup',
                text: 'Status',
                show: [
                    'physicalMeasurementsStatus:name',
                    'biobankSamples:name',
                    'membershipTier:name',
                    'consentStatus:name'
                ],
                hide: [
                    'contact:name',
                    'consent:name',
                    {% for field, label in surveys %}'ppi{{field}}:name', {% endfor %}
                ]
            },
            {
                extend: 'colvisGroup',
                text: 'Show all',
                show: ':hidden'
            }
        ]
    });
    table.buttons().container().find('.btn').addClass('btn-sm');
    $('#workqueue_length').addClass('pull-right');
});
</script>
{% endblock %}

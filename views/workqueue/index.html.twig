{% extends 'base.html.twig' %}
{% block title %}Participant Work Queue - {% endblock %}
{% block bodycontainer %}container-fluid{% endblock %}
{% block body %}
    <div class="page-header">
        <h2><i class="fa fa-table" aria-hidden="true"></i> Participant Work Queue</h2>
    </div>

    {% if isRdrError %}
        <div class="alert alert-danger">
            There was a problem with your request. Please refresh the page to try again.
        </div>
    {% endif %}

    <div class="well">
        <form id="filters">
            {% if filters.organization is defined %}
                <p><strong>Organization</strong></p>
                <div class="form-inline">
                    <select name="organization" class="form-control input-sm">
                        {% for label, value in filters.organization.options %}
                            <option value="{{ value }}"{% if organization == value %} selected="selected"{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <br />
            {% endif %}
            <p><strong>Filters</strong> <small><a href="{{ path('workqueue_index') }}">reset</a></p>
            <div class="form-inline">
                {% for name, filter in filters if name != 'organization' %}
                    <select name="{{ name }}" class="form-control input-sm">
                        <option value="">-- {{ filter.label }} --</option>
                        {% for label, value in filter.options %}
                            <option value="{{ value }}"{% if params[name]|default(false) == value %} selected="selected"{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                {% endfor %}
            </div>
        </form>
    </div>

    {% if isDownloadDisabled == false %}
        <p class="text-right">
            <button data-href="{{ path('workqueue_export', params) }}" class="btn btn-xs btn-default export"><i class="fa fa-download" aria-hidden="true"></i> Export</button>
        </p>
    {% endif %}
    <h4>{{ participants|length == constant('Pmi\\Controller\\WorkQueueController::LIMIT_DEFAULT') ? '>' }}{{ participants|length|number_format }}{{ params|length > 0 ? ' matching' }} participant{{ participants|length != 1 ? 's'}} ({{ organization }})</h4>
    <table class="table table-striped table-bordered table-small" id="workqueue" width="100%">
        <thead>
            <tr>
                <th rowspan="2" class="col-group-name">Last Name</th>
                <th rowspan="2" class="col-group-name">First Name</th>

                <th rowspan="2" class="col-group-default">Date of Birth</th>
                <th rowspan="2" class="col-group-info">PMI ID</th>
                <th rowspan="2" class="col-group-info">Biobank ID</th>
                <th rowspan="2" class="col-group-info">Language</th>
                <th rowspan="2" class="col-group-default">Participant Status</th>
                <th rowspan="2" class="col-group-default col-group-info">General Consent</th>
                <th rowspan="2" class="col-group-default col-group-info">EHR Consent</th>
                <th rowspan="2" class="col-group-info">CABoR Consent <span title="California Research Subjects' Bill of Rights is required for participants only by enrollment sites in California" data-toggle="tooltip"><i class="fa fa-question-circle text-info"></i></span></th>
                <th rowspan="2" class="col-group-default col-group-info">Withdrawal</th>

                <th colspan="4" class="topheader multiheader-contact">Contact</th>

                <th colspan="{{ 2 * (surveys|length) + 2 }}" class="topheader multiheader-survey">PPI Survey Completion</th>

                <th colspan="{{ 2 * (samples|length) + 6 }}" class="topheader multiheader-inperson">In-Person Enrollment</th>

                <th colspan="5" class="topheader multiheader-demographics">Demographics</th>
            </tr>
            <tr>
                <th class="secondaryheader col-group-contact multiheader-contact">Contact Method</th>
                <th class="secondaryheader col-group-contact multiheader-contact">Address</th>
                <th class="secondaryheader col-group-contact multiheader-contact">Email</th>
                <th class="secondaryheader col-group-contact multiheader-contact">Phone</th>

                <th class="secondaryheader col-group-ppi col-group-default multiheader-survey">Required Complete?</th>
                <th class="secondaryheader col-group-ppi col-group-default multiheader-survey">Completed Surveys</th>
                {% for field, label in surveys %}
                    <th class="secondaryheader col-group-ppi multiheader-survey">{{ label }}</th>
                    <th class="secondaryheader col-group-ppi-time multiheader-survey">{{ label }} Date</th>
                {% endfor %}

                <th class="secondaryheader col-group-inperson col-group-default multiheader-inperson">Paired Site Location</th>
                <th class="secondaryheader col-group-inperson col-group-default multiheader-inperson">Phys Measurements</th>
                <th class="secondaryheader col-group-inperson col-group-default multiheader-inperson">Phys Meas Location</th>
                <th class="secondaryheader col-group-inperson col-group-default multiheader-inperson">Samples for DNA Received?</th>
                <th class="secondaryheader col-group-inperson col-group-default multiheader-inperson">Bio&shy;specimens</th>
                {% for field, label in samples %}
                    <th class="secondaryheader col-group-inperson multiheader-inperson">{{ label }}</th>
                    <th class="secondaryheader col-group-inperson-time multiheader-inperson">{{ label }} Date</th>
                {% endfor %}
                <th class="secondaryheader col-group-inperson col-group-default multiheader-inperson">Bio&shy;specimens Location</th>

                <th class="secondaryheader col-group-demographics multiheader-demographics">Age</th>
                <th class="secondaryheader col-group-demographics multiheader-demographics">Sex</th>
                <th class="secondaryheader col-group-demographics multiheader-demographics">Gender Identity</th>
                <th class="secondaryheader col-group-demographics multiheader-demographics">Race/Ethnicity</th>
                <th class="secondaryheader col-group-demographics multiheader-demographics">Education</th>
            </tr>
        </thead>
        <tbody id="participant_info"></tbody>
    </table>
    {% if isDownloadDisabled == false %}
        <p class="text-right">
            <button data-href="{{ path('workqueue_export', params) }}" class="btn btn-xs btn-default export"><i class="fa fa-download" aria-hidden="true"></i> Export</button>
        </p>
    {% endif %}
{% endblock %}

{% block pagejs %}
<script>
$(document).ready(function() {
    var checkFilters = function () {
        if ($('select[name=withdrawalStatus]').val() == 'NO_USE') {
            $('select').not('[name=withdrawalStatus], [name=organization]').val('');
            $('select').not('[name=withdrawalStatus], [name=organization]').prop('disabled', true);
        } else {
            $('select').prop('disabled', false);
        }
    };
    checkFilters();
    $('#filters select').change(function() {
        checkFilters();
        $('#filters').submit();
    })
    $('button.export').click(function() {
        var location = $(this).data('href');
        new PmiConfirmModal({
            title: 'Attention',
            msg: 'The file you are about to download contains information that is sensitive and confidential. By clicking "accept" you agree not to distribute either the file or its contents, and to adhere to the <em>All of Us</em> Privacy and Trust Principles. A record of your acceptance will be stored at the Data and Research Center.',
            isHTML: true,
            onTrue: function() {
                window.location = location;
            },
            btnTextTrue: 'Accept'
        });
    });
    var url = window.location.href;
    var table = $('#workqueue').DataTable({
        pagingType: "simple",
        processing: true,
        serverSide: true,
        scrollX: true,
        ajax: url,
        order: [[7, 'desc']],
        dom: 'lBrtip',
        columns: [
            { name: 'lastName', data: 'lastName' },
            { name: 'firstName', data: 'firstName' },
            { name: 'dateOfBirth', data: 'dateOfBirth' },
            { name: 'participantId', visible: false, data: 'participantId' },
            { name: 'biobankId', visible: false, data: 'biobankId' },
            { name: 'language', visible: false, data: 'language'  },
            { name: 'participantStatus', data: 'participantStatus' },
            { name: 'generalConsent', data: 'generalConsent' },
            { name: 'ehrConsent', data: 'ehrConsent' },
            { name: 'caborConsent', visible: false, data: 'caborConsent' },
            { name: 'withdrawal', data: 'withdrawal' },
            { name: 'contactMethod', visible: false, data: 'contactMethod' },
            { name: 'address', visible: false, data: 'address', orderable: false },
            { name: 'email', visible: false, data: 'email' },
            { name: 'phone', visible: false, data: 'phone' },
            { name: 'ppiStatus', data: 'ppiStatus' },
            { name: 'ppiSurveys', data: 'ppiSurveys' },
            {% for field, label in surveys %}
                { name: 'ppi{{ field }}', visible: false, data: 'ppi{{ field }}' },
                { name: 'ppi{{ field }}Time', visible: false, data: 'ppi{{ field }}Time' },
            {% endfor %}
            { name: 'pairedSiteLocation', data: 'pairedSiteLocation' },
            { name: 'physicalMeasurementsStatus', data: 'physicalMeasurementsStatus' },
            { name: 'evaluationFinalizedSite', visible: false, data: 'evaluationFinalizedSite' },
            { name: 'biobankDnaStatus', data: 'biobankDnaStatus' },
            { name: 'biobankSamples', data: 'biobankSamples', orderable: false },
            {% for field, label in samples %}
                { name: 'sample{{ field }}', visible: false, data: 'sample{{ field }}' },
                { name: 'sample{{ field }}Time', visible: false, data: 'sample{{ field }}Time' },
            {% endfor %}
            { name: 'orderCreatedSite', visible: false, data: 'orderCreatedSite' },
            { name: 'age', visible: false, data: 'age' },
            { name: 'sex', visible: false, data: 'sex' },
            { name: 'genderIdentity', visible: false, data: 'genderIdentity' },
            { name: 'race', visible: false, data: 'race' },
            { name: 'education', visible: false, data: 'education' }
        ],
        columnDefs: [
            { className: "text-center", targets: [6, 7, 8, 9, 14, 15, 16, 18, 20, 22, 24, 26, 28, 30, 31, 32, 34, 36, 38, 40, 42, 44, 46, 48] }
        ],
        pageLength: 25,
        buttons: [
            {
                extend: 'colvisGroup',
                text: 'Default',
                show: [
                    '.col-group-default'
                ],
                hide: [
                    '.col-group-info:not(.col-group-default)',
                    '.col-group-ppi:not(.col-group-default)',
                    '.col-group-ppi-time',
                    '.col-group-inperson:not(.col-group-default)',
                    '.col-group-inperson-time',
                    '.col-group-demographics',
                    '.col-group-contact'
                ]
            },
            {
                extend: 'colvisGroup',
                text: 'PPI Surveys',
                show: [
                    'dateOfBirth:name',
                    '.col-group-ppi'
                ],
                hide: [
                    '.col-group-info',
                    '.col-group-ppi-time',
                    '.col-group-inperson',
                    '.col-group-inperson-time',
                    '.col-group-demographics',
                    '.col-group-contact'
                ]
            },
            {
                extend: 'colvisGroup',
                text: 'PPI Surveys + Dates',
                show: [
                    '.col-group-ppi',
                    '.col-group-ppi-time'
                ],
                hide: [
                    'dateOfBirth:name',
                    '.col-group-info',
                    '.col-group-inperson',
                    '.col-group-inperson-time',
                    '.col-group-demographics',
                    '.col-group-contact'
                ]
            },
            {
                extend: 'colvisGroup',
                text: 'In-Person',
                show: [
                    'dateOfBirth:name',
                    '.col-group-inperson'
                ],
                hide: [
                    '.col-group-info',
                    '.col-group-ppi',
                    '.col-group-ppi-time',
                    '.col-group-inperson-time',
                    '.col-group-demographics',
                    '.col-group-contact'
                ]
            },
            {
                extend: 'colvisGroup',
                text: 'In-Person + Sample Dates',
                show: [
                    '.col-group-inperson',
                    '.col-group-inperson-time'
                ],
                hide: [
                    'dateOfBirth:name',
                    '.col-group-info',
                    '.col-group-ppi',
                    '.col-group-ppi-time',
                    '.col-group-demographics',
                    '.col-group-contact'
                ]
            },
            {
                extend: 'colvisGroup',
                text: 'Demographics',
                show: [
                    'dateOfBirth:name',
                    '.col-group-demographics'
                ],
                hide: [
                    '.col-group-info',
                    '.col-group-inperson',
                    '.col-group-inperson-time',
                    '.col-group-ppi',
                    '.col-group-ppi-time',
                    '.col-group-contact'
                ]
            },
            {
                extend: 'colvisGroup',
                text: 'Contact',
                show: [
                    'dateOfBirth:name',
                    '.col-group-default',
                    '.col-group-contact'
                ],
                hide: [
                    '.col-group-demographics',
                    '.col-group-info:not(.col-group-default)',
                    '.col-group-inperson',
                    '.col-group-inperson-time',
                    '.col-group-ppi',
                    '.col-group-ppi-time'
                ]
            },
            {
                extend: 'colvisGroup',
                text: 'Show all',
                show: ':hidden'
            },
            {
                extend: 'colvis',
                text: 'Columns <i class="fa fa-caret-down" aria-hidden="true"></i>',
                columns: ':not(.col-group-name)'
            }
        ]
    });

    //Reset table data on page length change
    $('#workqueue').on('length.dt', function() {
        table.clear().draw();
    });

    table.buttons().container().find('.btn').addClass('btn-sm');
    $('#workqueue_length').addClass('pull-right');
    $('#workqueue_info').addClass('pull-left');
});
</script>
{% endblock %}

{% extends 'base.html.twig' %}
{% block title %}Participant Work Queue - {% endblock %}
{% block bodycontainer %}container-fluid{% endblock %}
{% block body %}
    <div class="page-header">
        <h2>Participant Work Queue</h2>
    </div>
    {#
    <div class="well">
        <p><strong>Filters</strong> <small><a href="{{ path('workqueue_index') }}">reset</a></p>
        <form class="form-inline" id="filters">
            {% for name, filter in filters %}
                <select name="{{ name }}" class="form-control input-sm">
                    <option value="">-- {{ filter.label }} --</option>
                    {% for label, value in filter.options %}
                        <option value="{{ value }}"{% if params[name]|default(false) == value %} selected="selected"{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            {% endfor %}
        </form>
    </div>
    #}
    <p class="text-right">
        <button data-href="{{ path('workqueue_export', params) }}" class="btn btn-xs btn-default export"><i class="fa fa-download" aria-hidden="true"></i> Export</button>
    </p>
    <h4>{{ participants|length|number_format }}{{ params|length > 0 ? ' matching' : '' }} participant{{ participants|length == 1 ? '' : 's'}} at Fake HPO Organization</h4>
    <table class="table table-striped table-bordered table-small" id="workqueue" width="100%">
        <thead>
            <tr>
                <th rowspan="2" class="col-group-name">Last Name</th>
                <th rowspan="2" class="col-group-name">First Name</th>
                <th rowspan="2">PMI ID</th>
                <th rowspan="2">Date of Birth</th>
                <th colspan="{{ 2 * (surveys|length) }}" class="topheader multiheader-survey">PPI Survey Completion</th>
                <th colspan="5" class="topheader multiheader-status">Status</th>
                <th colspan="2" class="topheader multiheader-demographics">Demographics</th>
            </tr>
            <tr>
                {% for field, label in surveys %}
                    <th class="secondaryheader col-group-ppi multiheader-survey">{{ label }}</th>
                    <th class="secondaryheader col-group-ppi-time multiheader-survey">{{ label }} Date</th>
                {% endfor %}
                <th class="secondaryheader col-group-status multiheader-status">Phys Meas</th>
                <th class="secondaryheader col-group-status multiheader-status">Bio&shy;specimens</th>
                <th class="secondaryheader col-group-status multiheader-status">General Consent</th>
                <th class="secondaryheader col-group-status multiheader-status">General Consent Date</th>
                <th class="secondaryheader col-group-status multiheader-status">EHR Consent</th>
                <th class="secondaryheader col-group-demographics multiheader-demographics">Race</th>
                <th class="secondaryheader col-group-demographics multiheader-demographics">Gender Identity</th>
            </tr>
        </thead>
        <tbody>
            {% for participant in participants %}
                <tr>
                    <td data-order="{{ participant.lastName|default('') }}"><a href="{{ path('participant', { id: participant.participantId }) }}">{{ participant.lastName|default('') }}</a></td>
                    <td data-order="{{ participant.firstName|default('') }}"><a href="{{ path('participant', { id: participant.participantId }) }}">{{ participant.firstName|default('') }}</a></td>
                    <td>{{ participant.participantId }}</td>
                    <td data-order="{{ participant.dateOfBirth|default('') }}">{{ participant.dateOfBirth is defined ? participant.dateOfBirth|date('m/d/Y') : '' }}</td>
                    {% for field, label in surveys %}
                        <td class="text-center" data-order="{{ attribute(participant, 'questionnaireOn' ~ field)|default('') == 'SUBMITTED' ? '1' : '0' }}">
                            {% if attribute(participant, 'questionnaireOn' ~ field)|default('') == 'SUBMITTED' %}
                                <i class="fa fa-check text-success" aria-hidden="true"></i>
                            {% else %}
                                <i class="fa fa-times text-danger" aria-hidden="true"></i>
                            {% endif %}
                        </td>
                        <td data-order="{{ attribute(participant, 'questionnaireOn' ~ field ~ 'Time')|default('') }}">
                            {% if attribute(participant, 'questionnaireOn' ~ field ~ 'Time') is defined %}
                                {{ attribute(participant, 'questionnaireOn' ~ field ~ 'Time')|date('m/d/Y') }}
                            {% endif %}
                        </td>
                    {% endfor %}

                    <td class="text-center" data-order="{{ participant.physicalMeasurementsStatus|default('') == 'COMPLETED' ? '1' : '0' }}">
                        {% if participant.physicalMeasurementsStatus|default('') == 'COMPLETED' %}
                            <i class="fa fa-check text-success" aria-hidden="true"></i>
                        {% else %}
                            <i class="fa fa-times text-danger" aria-hidden="true"></i>
                        {% endif %}
                    </td>
                    <td class="text-center" data-order="{{ participant.numBaselineSamplesArrived|default(0) }}">
                        <strong class="text-{{ participant.numBaselineSamplesArrived|default(0) >= 7 ? 'success' : 'danger' }}">{{ participant.numBaselineSamplesArrived }}</strong>
                    </td>
                    <td class="text-center" data-order="{{ participant.consentForStudyEnrollment|default('') == 'SUBMITTED' ? '1' : '0' }}">
                        {% if participant.consentForStudyEnrollment|default('') == 'SUBMITTED' %}
                            <i class="fa fa-check text-success" aria-hidden="true"></i>
                        {% else %}
                            <i class="fa fa-times text-danger" aria-hidden="true"></i>
                        {% endif %}
                    </td>
                    <td data-order="{{ participant.consentForStudyEnrollmentTime|default('') }}">{{ participant.consentForStudyEnrollmentTime is defined ? participant.consentForStudyEnrollmentTime|date('m/d/Y') : '' }}</td>
                    <td class="text-center" data-order="{{ participant.consentForElectronicHealthRecords|default('') == 'SUBMITTED' ? '1' : '0' }}">
                        {% if participant.consentForElectronicHealthRecords|default('') == 'SUBMITTED' %}
                            <i class="fa fa-check text-success" aria-hidden="true"></i>
                        {% else %}
                            <i class="fa fa-times text-danger" aria-hidden="true"></i>
                        {% endif %}
                    </td>
                    <td>{{ participant.race|default('')|display_code }}</td>
                    <td>{{ participant.genderIdentity|default('')|display_code }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    <p class="text-right">
        <button data-href="{{ path('workqueue_export', params) }}" class="btn btn-xs btn-default export"><i class="fa fa-download" aria-hidden="true"></i> Export</button>
    </p>
{% endblock %}

{% block pagejs %}
<script>
$(document).ready(function() {
    $('#filters select').change(function() {
        $('#filters').submit();
    })
    $('button.export').click(function() {
        var location = $(this).data('href');
        new PmiConfirmModal({
            title: 'Attention',
            msg: 'The file you are about to download contains information that is sensitive and confidential. By clicking "accept" you agree not to distribute either the file or its contents, and to adhere to the <em>All of Us</em> Privacy and Trust Principles. A record of your acceptance will be stored at the Data and Research Center.',
            isHTML: true,
            onTrue: function() {
                window.location = location;
            },
            btnTextTrue: 'Accept'
        });
    });
    var table = $('#workqueue').DataTable({
        dom: 'lBrtip',
        columns: [
            { name: 'lastName' },
            { name: 'firstName' },
            { name: 'participantId', visible: false },
            { name: 'dateOfBirth' },
            {% for field, label in surveys %}
                { name: 'ppi{{ field }}' },
                { name: 'ppi{{ field }}Time', visible: false },
            {% endfor %}
            { name: 'physicalMeasurementsStatus' },
            { name: 'biobankSamples' },
            { name: 'membershipTier' },
            { name: 'consentStatus' },
            { name: 'consentTime' },
            { name: 'race', visible: false },
            { name: 'genderIdentity', visible: false }
        ],
        pageLength: 25,
        buttons: [
            {
                extend: 'colvisGroup',
                text: 'Default',
                show: [
                    'dateOfBirth:name',
                    '.col-group-ppi',
                    '.col-group-status'
                ],
                hide: [
                    'participantId:name',
                    '.col-group-ppi-time',
                    '.col-group-demographics'
                ]
            },
            {
                extend: 'colvisGroup',
                text: 'PPI Surveys',
                show: [
                    'dateOfBirth:name',
                    '.col-group-ppi'
                ],
                hide: [
                    'participantId:name',
                    '.col-group-ppi-time',
                    '.col-group-status',
                    '.col-group-demographics'
                ]
            },
            {
                extend: 'colvisGroup',
                text: 'PPI Surveys + Date',
                show: [
                    '.col-group-ppi',
                    '.col-group-ppi-time'
                ],
                hide: [
                    'participantId:name',
                    'dateOfBirth:name',
                    '.col-group-status',
                    '.col-group-demographics'
                ]
            },
            {
                extend: 'colvisGroup',
                text: 'Status',
                show: [
                    'dateOfBirth:name',
                    '.col-group-status'
                ],
                hide: [
                    'participantId:name',
                    '.col-group-ppi',
                    '.col-group-ppi-time',
                    '.col-group-demographics'
                ]
            },
            {
                extend: 'colvisGroup',
                text: 'Demographics',
                show: [
                    'dateOfBirth:name',
                    '.col-group-demographics'
                ],
                hide: [
                    'participantId:name',
                    '.col-group-status',
                    '.col-group-ppi',
                    '.col-group-ppi-time'
                ]
            },
            {
                extend: 'colvisGroup',
                text: 'Show all',
                show: ':hidden'
            },
            {
                extend: 'colvis',
                text: 'Columns <i class="fa fa-caret-down" aria-hidden="true"></i>',
                columns: ':not(.col-group-name)'
            }
        ]
    });
    table.buttons().container().find('.btn').addClass('btn-sm');
    $('#workqueue_length').addClass('pull-right');
    $('#workqueue_info').addClass('pull-left');
});
</script>
{% endblock %}

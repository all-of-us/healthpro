{% extends 'base.html.twig' %}
{% block title %}Participant Work Queue - {% endblock %}
{% block bodycontainer %}container-fluid{% endblock %}
{% block body %}
    <div class="page-header">
        <h2>Participant Work Queue</h2>
    </div>

    <div class="well">
        <p><strong>Filters</strong> <small><a href="{{ path('workqueue_index') }}">reset</a></p>
        <form class="form-inline" id="filters">
            {% for name, filter in filters %}
                <select name="{{ name }}" class="form-control input-sm">
                    <option value="">-- {{ filter.label }} --</option>
                    {% for label, value in filter.options %}
                        <option value="{{ value }}"{% if params[name]|default(false) == value %} selected="selected"{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            {% endfor %}
        </form>
    </div>

    <p class="text-right">
        <button data-href="{{ path('workqueue_export', params) }}" class="btn btn-xs btn-default export"><i class="fa fa-download" aria-hidden="true"></i> Export</button>
    </p>
    <h4>{{ participants|length|number_format }}{{ params|length > 0 ? ' matching' : '' }} participant{{ participants|length == 1 ? '' : 's'}} at Fake HPO Organization</h4>
    <table class="table table-striped table-bordered table-small" id="workqueue" width="100%">
        <thead>
            <tr>
                <th rowspan="2" class="col-group-name">Last Name</th>
                <th rowspan="2" class="col-group-name">First Name</th>

                <th rowspan="2" class="col-group-default">Date of Birth</th>
                <th rowspan="2" class="col-group-info">PMI ID</th>
                <th rowspan="2" class="col-group-info">Language</th>
                <th rowspan="2" class="col-group-default col-group-info">General Consent</th>
                <th rowspan="2" class="col-group-default col-group-info">EHR Consent</th>
                <th rowspan="2" class="col-group-default col-group-info">Withdrawal</th>

                <th colspan="4" class="topheader multiheader-contact">Contact</th>

                <th colspan="{{ 2 * (surveys|length) + 2 }}" class="topheader multiheader-survey">PPI Survey Completion</th>

                <th colspan="2" class="topheader multiheader-status">Status</th>

                <th colspan="7" class="topheader multiheader-demographics">Demographics</th>
            </tr>
            <tr>
                <th class="secondaryheader col-group-contact multiheader-contact">Contact Method</th>
                <th class="secondaryheader col-group-contact multiheader-contact">Address</th>
                <th class="secondaryheader col-group-contact multiheader-contact">Email</th>
                <th class="secondaryheader col-group-contact multiheader-contact">Phone</th>

                <th class="secondaryheader col-group-ppi multiheader-survey">Required Complete?</th>
                <th class="secondaryheader col-group-ppi multiheader-survey">Completed Surveys</th>
                {% for field, label in surveys %}
                    <th class="secondaryheader col-group-ppi multiheader-survey">{{ label }}</th>
                    <th class="secondaryheader col-group-ppi-time multiheader-survey">{{ label }} Date</th>
                {% endfor %}

                <th class="secondaryheader col-group-status multiheader-status">Phys Meas</th>
                <th class="secondaryheader col-group-status multiheader-status">Bio&shy;specimens</th>

                <th class="secondaryheader col-group-demographics multiheader-demographics">Age</th>
                <th class="secondaryheader col-group-demographics multiheader-demographics">Sex</th>
                <th class="secondaryheader col-group-demographics multiheader-demographics">Gender Identity</th>
                <th class="secondaryheader col-group-demographics multiheader-demographics">Sexual Orientation</th>
                <th class="secondaryheader col-group-demographics multiheader-demographics">Race/Ethnicity</th>
                <th class="secondaryheader col-group-demographics multiheader-demographics">Education</th>
                <th class="secondaryheader col-group-demographics multiheader-demographics">Income</th>
            </tr>
        </thead>
        <tbody>
            {% for participant in participants %}
                <tr>
                    <td data-order="{{ participant.lastName }}"><a href="{{ path('participant', { id: participant.id }) }}">{{ participant.lastName }}</a></td>
                    <td data-order="{{ participant.firstName }}"><a href="{{ path('participant', { id: participant.id }) }}">{{ participant.firstName }}</a></td>
                    <td data-order="{{ participant.dob ? participant.dob|date('Y-m-d') : '' }}">{{ participant.dob ? participant.dob|date('m/d/Y') : '' }}</td>
                    <td>{{ participant.id }}</td>
                    <td>{{ participant.language }}</td>
                    <td class="text-center" data-order="{{ participant.consentForStudyEnrollment == 'SUBMITTED' ? '1' : '0' }}-{{ participant.consentForStudyEnrollmentTime }}">
                        {% if participant.consentForStudyEnrollment == 'SUBMITTED' %}
                            <i class="fa fa-check text-success" aria-hidden="true"></i>
                            {{ participant.consentForStudyEnrollmentTime ? participant.consentForStudyEnrollmentTime|date('m/d/Y') : '' }}
                        {% else %}
                            <i class="fa fa-times text-danger" aria-hidden="true"></i>
                        {% endif %}
                    </td>
                    <td class="text-center" data-order="{{ participant.consentForElectronicHealthRecords == 'SUBMITTED' ? '1' : '0' }}-{{ participant.consentForElectronicHealthRecordsTime }}">
                        {% if participant.consentForElectronicHealthRecords == 'SUBMITTED' %}
                            <i class="fa fa-check text-success" aria-hidden="true"></i>
                            {{ participant.consentForElectronicHealthRecordsTime ? participant.consentForElectronicHealthRecordsTime|date('m/d/Y') : '' }}
                        {% else %}
                            <i class="fa fa-times text-danger" aria-hidden="true"></i>
                        {% endif %}
                    </td>
                    <td class="text-center" data-order="{{ participant.withdrawalStatus == 'NO_USE' ? '1' : '0' }}">
                        {% if participant.withdrawalStatus == 'NO_USE' %}
                            <i class="fa fa-times text-danger" aria-hidden="true"></i>
                            No Use
                        {% endif %}
                    </td>

                    <td>{{ participant.recontactMethod }}</td>
                    <td>{{ participant.getAddress() }}</td>
                    <td>{{ participant.email }}</td>
                    <td>{{ participant.phoneNumber }}</td>

                    <td class="text-center" data-order="{{ participant.numCompletedBaselinePPIModules == 3 ? '1' : '0' }}">
                        {% if participant.numCompletedBaselinePPIModules == 3 %}
                            <i class="fa fa-check text-success" aria-hidden="true"></i>
                        {% else %}
                            <i class="fa fa-times text-danger" aria-hidden="true"></i>
                        {% endif %}
                    </td>
                    <td class="text-center">{{ participant.numCompletedPPIModules }}</td>
                    {% for field, label in surveys %}
                        <td class="text-center" data-order="{{ attribute(participant, 'questionnaireOn' ~ field) == 'SUBMITTED' ? '1' : '0' }}">
                            {% if attribute(participant, 'questionnaireOn' ~ field) == 'SUBMITTED' %}
                                <i class="fa fa-check text-success" aria-hidden="true"></i>
                            {% else %}
                                <i class="fa fa-times text-danger" aria-hidden="true"></i>
                            {% endif %}
                        </td>
                        <td data-order="{{ attribute(participant, 'questionnaireOn' ~ field ~ 'Time') }}">
                            {% if attribute(participant, 'questionnaireOn' ~ field ~ 'Time') %}
                                {{ attribute(participant, 'questionnaireOn' ~ field ~ 'Time')|date('m/d/Y') }}
                            {% endif %}
                        </td>
                    {% endfor %}

                    <td class="text-center" data-order="{{ participant.physicalMeasurementsStatus == 'COMPLETED' ? '1' : '0' }}">
                        {% if participant.physicalMeasurementsStatus == 'COMPLETED' %}
                            <i class="fa fa-check text-success" aria-hidden="true"></i>
                        {% else %}
                            <i class="fa fa-times text-danger" aria-hidden="true"></i>
                        {% endif %}
                    </td>
                    <td class="text-center" data-order="{{ participant.numBaselineSamplesArrived }}">
                        <strong class="text-{{ participant.numBaselineSamplesArrived >= 7 ? 'success' : 'danger' }}">{{ participant.numBaselineSamplesArrived }}</strong>
                    </td>

                    <td>{{ participant.getAge() }}</td>
                    <td>{{ participant.sex }}</td>
                    <td>{{ participant.genderIdentity }}</td>
                    <td>{{ participant.sexualOrientation }}</td>
                    <td>{{ participant.race }}</td>
                    <td>{{ participant.education }}</td>
                    <td>{{ participant.income }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    <p class="text-right">
        <button data-href="{{ path('workqueue_export', params) }}" class="btn btn-xs btn-default export"><i class="fa fa-download" aria-hidden="true"></i> Export</button>
    </p>
{% endblock %}

{% block pagejs %}
<script>
$(document).ready(function() {
    $('#filters select').change(function() {
        $('#filters').submit();
    })
    $('button.export').click(function() {
        var location = $(this).data('href');
        new PmiConfirmModal({
            title: 'Attention',
            msg: 'The file you are about to download contains information that is sensitive and confidential. By clicking "accept" you agree not to distribute either the file or its contents, and to adhere to the <em>All of Us</em> Privacy and Trust Principles. A record of your acceptance will be stored at the Data and Research Center.',
            isHTML: true,
            onTrue: function() {
                window.location = location;
            },
            btnTextTrue: 'Accept'
        });
    });
    var table = $('#workqueue').DataTable({
        dom: 'lBrtip',
        columns: [
            { name: 'lastName' },
            { name: 'firstName' },
            { name: 'dateOfBirth' },
            { name: 'participantId', visible: false },
            { name: 'language', visible: false  },
            { name: 'generalConsent' },
            { name: 'ehrConsent' },
            { name: 'withdrawal' },
            { name: 'contactMethod', visible: false },
            { name: 'address', visible: false },
            { name: 'email', visible: false  },
            { name: 'phone', visible: false  },
            { name: 'ppiStatus' },
            { name: 'ppiSurveys' },
            {% for field, label in surveys %}
                { name: 'ppi{{ field }}' },
                { name: 'ppi{{ field }}Time', visible: false },
            {% endfor %}
            { name: 'physicalMeasurementsStatus' },
            { name: 'biobankSamples' },
            { name: 'age', visible: false },
            { name: 'sex', visible: false },
            { name: 'genderIdentity', visible: false },
            { name: 'sexualOrientation', visible: false },
            { name: 'race', visible: false },
            { name: 'education', visible: false },
            { name: 'income', visible: false }
        ],
        pageLength: 25,
        buttons: [
            {
                extend: 'colvisGroup',
                text: 'Default',
                show: [
                    '.col-group-default',
                    '.col-group-ppi',
                    '.col-group-status'
                ],
                hide: [
                    '.col-group-info:not(.col-group-default)',
                    '.col-group-ppi-time',
                    '.col-group-demographics',
                    '.col-group-contact'
                ]
            },
            {
                extend: 'colvisGroup',
                text: 'PPI Surveys',
                show: [
                    'dateOfBirth:name',
                    '.col-group-ppi'
                ],
                hide: [
                    '.col-group-info',
                    '.col-group-ppi-time',
                    '.col-group-status',
                    '.col-group-demographics',
                    '.col-group-contact'
                ]
            },
            {
                extend: 'colvisGroup',
                text: 'PPI Surveys + Date',
                show: [
                    '.col-group-ppi',
                    '.col-group-ppi-time'
                ],
                hide: [
                    'dateOfBirth:name',
                    '.col-group-info',
                    '.col-group-status',
                    '.col-group-demographics',
                    '.col-group-contact'
                ]
            },
            {
                extend: 'colvisGroup',
                text: 'Status',
                show: [
                    '.col-group-info',
                    '.col-group-status'
                ],
                hide: [
                    '.col-group-ppi',
                    '.col-group-ppi-time',
                    '.col-group-demographics',
                    '.col-group-contact'
                ]
            },
            {
                extend: 'colvisGroup',
                text: 'Demographics',
                show: [
                    'dateOfBirth:name',
                    '.col-group-demographics'
                ],
                hide: [
                    '.col-group-info',
                    '.col-group-status',
                    '.col-group-ppi',
                    '.col-group-ppi-time',
                    '.col-group-contact'
                ]
            },
            {
                extend: 'colvisGroup',
                text: 'Contact',
                show: [
                    'dateOfBirth:name',
                    '.col-group-default',
                    '.col-group-contact'
                ],
                hide: [
                    '.col-group-demographics',
                    '.col-group-info:not(.col-group-default)',
                    '.col-group-status',
                    '.col-group-ppi',
                    '.col-group-ppi-time'
                ]
            },
            {
                extend: 'colvisGroup',
                text: 'Show all',
                show: ':hidden'
            },
            {
                extend: 'colvis',
                text: 'Columns <i class="fa fa-caret-down" aria-hidden="true"></i>',
                columns: ':not(.col-group-name)'
            }
        ]
    });
    table.buttons().container().find('.btn').addClass('btn-sm');
    $('#workqueue_length').addClass('pull-right');
    $('#workqueue_info').addClass('pull-left');
});
</script>
{% endblock %}

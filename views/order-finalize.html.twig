{% extends 'base.html.twig' %}
{% import 'order-samples.html.twig' as samples %}
{% if order.type != 'saliva' %}
    {% form_theme finalizeForm 'form/simple_checkbox.html.twig' %}
{% endif %}
{% block title %}Finalize - Order {{ order.order_id }} - {% endblock %}
{% block body %}
    {% include 'order-header.html.twig' with { active: 'finalize' } %}
    {{ form_start(finalizeForm, { attr: { class: 'warn-unsaved' } }) }}
        {{ form_errors(finalizeForm) }}

        <div class="form-group{% if not finalizeForm.finalized_ts.vars.valid %} has-error{% endif %}">
            {{ form_label(finalizeForm.finalized_ts) }}
                <span class="toggle-help-image" data-caption="Finalized time help text placeholder.">
                    <i class="fa fa-question-circle" aria-hidden="true"></i><span class="sr-only">Help</span>
                </span>
            {{ form_widget(finalizeForm.finalized_ts) }}
            {{ form_errors(finalizeForm.finalized_ts) }}
        </div>

        <div class="form-group{% if not finalizeForm.finalized_samples.vars.valid %} has-error{% endif %}">
            {{ form_label(finalizeForm.finalized_samples) }}
            <span class="toggle-help-image" data-caption="Finalized samples help text placeholder.">
                <i class="fa fa-question-circle" aria-hidden="true"></i><span class="sr-only">Help</span>
            </span>
            {% if order.type == 'saliva' %}
                {{ form_widget(finalizeForm.finalized_samples) }}
            {% else %}
                {{ samples.form_widget(finalizeForm.finalized_samples, order.finalized_ts ? false : true, samplesInfo) }}
            {% endif %}
            {{ form_errors(finalizeForm.finalized_samples) }}
        </div>

        {% if finalizeForm.fedex_tracking is defined %}
            <ul class="nav nav-tabs">
                <li role="presentation" class="active"><a href="#" id="enable-number">
                    <i class="fa fa-keyboard-o" aria-hidden="true"></i>
                    Enter tracking number
                </a></li>
                <li role="presentation"><a href="#" id="enable-barcode">
                    <i class="fa fa-barcode" aria-hidden="true"></i>
                    Scan barcode
                </a></li>
            </ul>
            <br />
            <div class="row">
                <div class="col-xs-6" id="fedex-barcode" style="display:none">
                    <div class="form-group">
                        <label class="control-label" for="fedex_barcode_first">FedEx or UPS barcode</label>
                        <input type="text" id="fedex_barcode_first" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="control-label" for="fedex_barcode_second">Verify barcode</label>
                        <input type="text" id="fedex_barcode_second" class="form-control">
                    </div>
                </div>
                <div class="col-xs-12" id="fedex-number">
                    {{ form_row(finalizeForm.fedex_tracking) }}
                </div>
            </div>
            <hr />
        {% endif %}

        <div class="form-group{% if not finalizeForm.finalized_notes.vars.valid %} has-error{% endif %}">
            {{ form_label(finalizeForm.finalized_notes) }}
            <span class="toggle-help-image" data-caption="Finalized notes help text placeholder.">
                    <i class="fa fa-question-circle" aria-hidden="true"></i><span class="sr-only">Help</span>
                </span>
            {{ form_widget(finalizeForm.finalized_notes) }}
            <small class="text-warning">Comments entered in this field must be transmitted to the Biobank via reconciliation reporting. You may not enter any participant identifying information here.</small>
            {{ form_errors(finalizeForm.finalized_notes) }}
        </div>
        {{ form_rest(finalizeForm) }}
        {% if not order.finalized_ts %}
            <p>
                <button type="submit" class="btn btn-primary" onclick="return confirm('Are you sure you want to finalize this order?');" {% if hasErrors %} disabled="disabled" {% endif %}>
                    Save and mark as finalized
                </button>
            </p>
        {% endif %}
    {{ form_end(finalizeForm) }}

{% endblock %}

{% block pagejs %}
<script>
$(document).ready(function () {
    var html;
    {% if order.type == 'saliva' %}
        $('input.sample-disabled').closest('label').addClass('text-danger');
        var collected = $('input[name="form[finalized_samples][]"]').attr('collected');
        var processed = $('input[name="form[finalized_samples][]"]').attr('processed');
        if (typeof collected !== 'undefined') {
            html = '<label><b>Collected: </b></label> <i class="fa fa-check text-success" aria-hidden="true"></i>'+collected+'</span>';
        } else {
            html += '<label><b>Collected: </b></label> <span class="label-normal text-danger">Not collected</span></span>';
        }
        if (typeof processed !== 'undefined') {
            html += '<label><b>Processed: </b></label> <i class="fa fa-check text-success" aria-hidden="true"></i>'+processed+'</span>';
        } else {
            html += '<label><b>Processed: </b></label> <span class="label-normal text-danger">Not processed</span></span>';
        }
        $('input[name="form[finalized_samples][]"]').closest('div.checkbox').append('<span class="saliva-info">'+html+'</span>');
    {% else %}
        $('.sample-disabled label').addClass('text-danger');
        $('.header-collected').append('<br><small>'+{{ order.collected_ts.format('n/j/Y g:ia')|json_encode|raw }}+'</small>');
        $('.samples').each(function(e) {
            var collected = $(this).find('input[name="form[finalized_samples][]"]').attr('collected');
            var processed = $(this).find('input[name="form[finalized_samples][]"]').attr('processed');
            var requiredProcessing = $(this).find('input[name="form[finalized_samples][]"]').attr('required-processing');
            var warning = $(this).find('input[name="form[finalized_samples][]"]').attr('warning');
            var error = $(this).find('input[name="form[finalized_samples][]"]').attr('error');
            if (typeof collected !== 'undefined') {
                html = '<td align="center"><i class="fa fa-check text-success" aria-hidden="true"></i></td>';
            } else {
                html += '<td align="center"><label class="label-normal text-danger">Not collected</label></td>';
            }
            if (typeof processed !== 'undefined') {
                html += '<td>';
                if (typeof error !== 'undefined') {
                    html += '<span class="text-danger"><i class="glyphicon glyphicon-exclamation-sign" aria-hidden="true" data-toggle="tooltip" data-placement="bottom" title="'+error+'"></i> '+processed+'</span>';
                } else if (typeof warning !== 'undefined') {
                    html += '<span class="text-warning"><i class="fa fa-exclamation-triangle text-warning" aria-hidden="true" data-toggle="tooltip" data-placement="bottom" title="'+warning+'"></i> '+processed+'</span></i> ';
                }else {
                    html += '<i class="fa fa-check text-success" aria-hidden="true"></i> '+processed;
                }
                html += '</td>';
            } else {
                if (typeof requiredProcessing !== 'undefined') {
                    html += '<td align="center"><label class="label-normal text-danger">Not processed</label></td>';
                }
            }
            $(this).find('td:last').after(html);
            $('[data-toggle="tooltip"]').tooltip()
        });
    {% endif %}

    $('#checkall').on('change', function() {
        $('#form_finalized_samples input:checkbox:enabled').prop('checked', $(this).prop('checked'));
    });
    $('#form_finalized_ts').pmiDateTimePicker();
    var orderView = new PMI.views['OrderSubPage']({
        el: $("body")
    });

    $('#enable-number').on('click', function() {
        $('#enable-number').parent().addClass('active');
        $('#enable-barcode').parent().removeClass('active');
        $('#fedex-barcode').hide();
        $('#fedex-number').removeClass('col-xs-6').addClass('col-xs-12');
        $('#fedex-number input').attr('readonly', false);
        return false;
    });
    $('#enable-barcode').on('click', function() {
        $('#enable-barcode').parent().addClass('active');
        $('#enable-number').parent().removeClass('active');
        $('#fedex-barcode').show();
        $('#fedex-number').removeClass('col-xs-12').addClass('col-xs-6');
        $('#fedex-number input').attr('readonly', true);
        return false;
    });

    $('#fedex_barcode_first, #fedex_barcode_second').on('change keyup', function() {
        var target;
        if ($(this).attr('id') === 'fedex_barcode_second') {
            target = $('#form_fedex_tracking_second');
        } else {
            target = $('#form_fedex_tracking_first');
        }
        target.attr('placeholder', '');
        target.parent().removeClass('has-error').removeClass('has-success');
        var barcode = $(this).val().trim();
        if (barcode.match(/^[a-zA-Z0-9]{18}$/)) { // 18 digit alphanumeric barcode for UPS
            target.val(barcode);
            target.parent().addClass('has-success');
        }
        else if (barcode.match(/^[0-9]{34}$/)) { // 34 digit barcode for FedEx
            var fedexTracking = barcode.substring(20);
            fedexTracking = fedexTracking.replace(/^0{1,2}/, ''); // trim up to two leading 0's
            target.val(fedexTracking);
            target.parent().addClass('has-success');
        } else {
            target.val('');
            if (barcode) {
                target.attr('placeholder', 'Invalid barcode');
                target.parent().addClass('has-error');
            }
        }
    });
});
</script>
{% endblock %}

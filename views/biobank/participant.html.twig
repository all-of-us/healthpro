{% extends 'base.html.twig' %}
{% block title %}Participant {{ participant.id }} - {% endblock %}
{% block body %}
    <div class="row">
        <div class="col-sm-6">
            <dl class="dl-horizontal">
                {% if is_granted('ROLE_SCRIPPS') %}
                    <dt>Participant ID</dt>
                    <dd>{{ participant.id }}</dd>
                {% endif %}
                <dt>Biobank ID</dt>
                <dd>{{ participant.biobankId }}</dd>
                <dt>Paired Awardee</dt>
                <dd>{{ participant.awardee ? app.getAwardeeDisplayName(participant.awardee) : '(not paired)' }}</dd>
                <dt>Paired Site</dt>
                <dd>{{ participant.site ? app.getSiteDisplayName(participant.siteSuffix) : '(not paired)' }}</dd>
            </dl>
        </div>
    </div>
    <div role="tabpanel">
        <ul class="nav nav-tabs" role="tablist">
            <li role="presentation" class="active">
                <a href="#inperson" aria-controls="inperson" role="tab" data-toggle="tab">In-Person Enrollment</a>
            </li>
        </ul>
        <br />
        <div class="tab-content">
            <div role="tabpanel" class="tab-pane active" id="inperson">
                {% if participant.status %}
                    <div class="row">
                        <div class="col-sm-6 {{ app.isDVType ? 'col-lg-4' : 'col-lg-6' }}">
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <h3 class="panel-title"><i class="fa fa-medkit" aria-hidden="true"></i> Biobank Orders</h3>
                                </div>
                                <div class="panel-body">
                                    {% if orders is not empty %}
                                        {% for order in orders %}
                                            {% if loop.index == 6 %}
                                                <div id="order-overflow">
                                            {% endif %}
                                            <a href="{{ path('biobank_order', { biobankId: participant.biobankId, orderId: order.id }) }}" class="btn btn-block btn-lg {% if orderId is defined and order.id == orderId %} btn-warning {% else %} btn-default {% endif %}">
                                                {{ order.created_ts|date('D n/j/Y', app.userTimezone) }}
                                                <small class="text-muted"><strong>{{ order.order_id }}</strong></small>
                                                <br/>
                                                <small class="text-muted">
                                                    {% if order.oh_type == 'cancel' %}
                                                        <span class="label label-danger">Cancelled</span> {{ order.oh_created_ts|date('n/j/Y g:ia', app.userTimezone) }}
                                                    {% elseif not order.finalized_ts and not order.version %}
                                                        <span class="label label-danger">Expired</span>
                                                    {% elseif order.oh_type == 'unlock' %}
                                                        <span class="label label-primary">Unlocked for editing</span> {{ order.oh_created_ts|date('n/j/Y g:ia', app.userTimezone) }}
                                                    {% elseif order.oh_type == 'edit' %}
                                                        <span class="label label-success">Edited &amp; Finalized</span> {{ order.oh_created_ts|date('n/j/Y g:ia', app.userTimezone) }}
                                                    {% elseif order.finalized_ts and order.rdr_id %}
                                                        <span class="label label-success">Finalized</span> {{ order.finalized_ts|date('n/j/Y g:ia', app.userTimezone) }}
                                                    {% elseif order.processed_ts %}
                                                        <span class="label label-info">Processed</span> {{ order.processed_ts|date('n/j/Y g:ia', app.userTimezone) }}
                                                    {% elseif order.collected_ts %}
                                                        <span class="label label-default">Collected</span> {{ order.collected_ts|date('n/j/Y g:ia', app.userTimezone) }}
                                                    {% endif %}
                                                </small>
                                            </a>
                                        {% endfor %}
                                        {% if orders|length > 5 %}
                                            </div> {# close .order-overflow div above #}
                                            <a href="#" class="btn btn-block btn-lg btn-default" id="order-overflow-show">
                                                <i class="fa fa-chevron-circle-down" aria-hidden="true"></i> Show all
                                            </a>
                                        {% endif %}
                                    {% else %}
                                        <div class="alert alert-warning" role="alert">
                                            No orders for this participant
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    {% if participant.statusReason == 'test-participant' %}
                        {% set errorTitle = 'This is not a real participant' %}
                        {% set errorMessage = 'Data collection and entry for test participants are prohibited in this environment. You may not create a biobank order or collect physical measurements for this participant.' %}
                    {% elseif participant.statusReason == 'basics' %}
                        {% set errorTitle = 'The Basics survey not complete' %}
                        {% set errorMessage = 'This participant has consented but has not completed "The Basics" survey in the participant app and is therefore ineligible for physical measurements and biospecimen collection. Please direct the participant to complete "The Basics" survey in the participant application to enable in person enrollment or contact the help desk if needed.' %}
                    {% elseif participant.statusReason == 'withdrawal' %}
                        {% set errorTitle = 'Withdrawn participant' %}
                        {% set errorMessage = 'This participant has withdrawn from the All of Us Research Program. No new data can be collected or sent for this participant. Staff must also follow all site-specific SOPs to ensure all All of Us Research Program data are removed from all local systems for this participant.' %}
                    {% else %}
                        {% set errorTitle = 'Consent not complete' %}
                        {% set errorMessage = 'This participant has not completed consent for enrollment.' %}
                    {% endif %}
                    <div class="row">
                        <div class="col-sm-8 col-sm-push-2 col-lg-6 col-lg-push-3">
                            <div class="panel panel-danger">
                                <div class="panel-heading">
                                    <h3 class="panel-title"><i class="fa fa-times-circle" aria-hidden="true"></i> {{ errorTitle }}</h3>
                                </div>
                                <div class="panel-body">
                                    <p>{{ errorMessage }}</p>
                                    {% if participant.statusReason == 'withdrawal' and participant.withdrawalReason is not empty %}
                                        <p>
                                            <strong>Reason:</strong> {{ participant.withdrawalReason }}
                                            {% if participant.withdrawalReasonJustification is not empty %}
                                                <br /><strong>Justification:</strong> {{ participant.withdrawalReasonJustification }}
                                            {% endif %}
                                        </p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}

{% block pagejs %}
    <script>
        $(document).ready(function() {
            $('#order-overflow-show').on('click', function(e) {
                $(this).hide();
                $('#order-overflow').show();
                e.preventDefault();
            });
        });
    </script>
{% endblock %}
